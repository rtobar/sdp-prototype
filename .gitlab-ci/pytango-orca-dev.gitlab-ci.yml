# Common variables
.pytango-orca-dev-vars: &pytango-orca-dev-vars
  variables:
    IMAGE_NAME: pytango-orca-dev-0.3.0
    IMAGE_TAG: buster-slim
    IMAGE_PATH: docker/pytango-orca-dev/0.3.0/buster-slim

# Logic for only running job if changes and not tag
.pytango-orca-dev-changes: &pytango-orca-dev-changes
  only:
    changes:
      - docker/pytango-orca-dev/0.3.0/buster-slim/Dockerfile
  except:
    refs:
      - tags

# Logic for only running job if tag
.pytango-orca-dev-tag: &pytango-orca-dev-tag
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_TAG =~ /^(pytango-orca-dev-0.3.0)/

# -----------------------------------------------------------------------------
# Build
# -----------------------------------------------------------------------------
.pytango-orca-dev-0.3.0-buster-slim-build:
  extends: .docker-two-stage-build
  <<: *pytango-orca-dev-vars

pytango-orca-dev-0.3.0:buster-slim build - changes:
  extends: .pytango-orca-dev-0.3.0-buster-slim-build
  <<: *pytango-orca-dev-changes

pytango-orca-dev-0.3.0:buster-slim build - tag:
  extends: .pytango-orca-dev-0.3.0-buster-slim-build
  <<: *pytango-orca-dev-tag

# -----------------------------------------------------------------------------
# Test
# -----------------------------------------------------------------------------
.pytango-orca-dev-0.3.0:buster-slim test:
  extends: .docker-test-image
  <<: *pytango-orca-dev-vars
  script:
    - echo "$CI_COMMIT_TAG"
    - echo "$CI_COMMIT_MESSAGE"
    - echo "$IMAGE_NAME"
    - cd $IMAGE_PATH
    - pip list
    - python3 -c "import tango; print(tango.__version__)"
    # TODO Test this image!

pytango-orca-dev-0.3.0:buster-slim test - changes:
  extends: .pytango-orca-dev-0.3.0:buster-slim test
  <<: *pytango-orca-dev-changes

pytango-orca-dev-0.3.0:buster-slim test - tag:
  extends: .pytango-orca-dev-0.3.0:buster-slim test
  <<: *pytango-orca-dev-tag

# -----------------------------------------------------------------------------
# Publish / push
# -----------------------------------------------------------------------------
pytango-orca-dev-0.3.0:buster-slim publish:
  extends: .docker-push-image
  <<: *pytango-orca-dev-vars
  <<: *pytango-orca-dev-tag
